<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Generic Metrics Relay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 960px; }
    fieldset { margin-bottom: 1.5rem; border: 1px solid #ccc; padding: 1rem; }
    legend { font-weight: bold; }
    label { display: block; margin-bottom: 0.5rem; }
    input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 0.5rem; }
    .checkbox-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .error { color: #b30000; margin-bottom: 1rem; font-weight: bold; }
    .warning { background: #fff4cd; border: 1px solid #f0c36d; padding: 0.75rem 1rem; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
    .pair-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .pair-grid input { width: 100%; }
    .pair-grid button { width: auto; }
    .section-actions { margin-top: 0.75rem; }
  </style>
</head>
<body>
  <h1>Generic Metrics Relay</h1>
  <p>Submit custom metrics and dimensions to one or more Dynatrace tenants.</p>
  {% if not auth_configured %}
    <div class="warning">
      <strong>Configuration required:</strong>
      Set the <code>AUTH_PASSWORD</code> environment variable on the server before attempting an ingest.
    </div>
  {% endif %}
  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}
  <form method="post" action="{{ url_for('metrics.ingest') }}">
    <fieldset>
      <legend>Tenant Selection</legend>
      <div class="checkbox-group">
        {% for tenant in tenants %}
          <label>
            <input type="checkbox" name="tenant_ids" value="{{ tenant.id }}" {% if tenant.id in selected_tenants %}checked{% endif %}>
            {{ tenant.label }} ({{ tenant.id }})
          </label>
        {% endfor %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Authentication</legend>
      <label>Site password
        <input type="password" name="auth_password" required>
      </label>
      <label>Global Dynatrace ingest token
        <input type="password" name="dt_token" {% if require_global_token %}required{% endif %}>
      </label>
      <div class="tokens">
        <details>
          <summary>Optional per-tenant tokens</summary>
          {% for tenant in tenants %}
            <label>{{ tenant.label }} override
              <input type="password" name="dt_token__{{ tenant.id }}">
            </label>
          {% endfor %}
        </details>
      </div>
    </fieldset>

    <fieldset>
      <legend>Metric Configuration</legend>
      <label>Metric prefix
        <input type="text" name="metric_prefix" value="{{ form_defaults.metric_prefix }}" required>
      </label>
    </fieldset>

    <fieldset>
      <legend>Dimensions</legend>
      <p>Add key/value pairs to send as dimensions with each metric line.</p>
      <div id="dimensions-container">
        {% for key, value in initial_dimensions %}
          <div class="pair-grid">
            <input type="text" name="dim_keys" placeholder="Dimension key" value="{{ key }}">
            <input type="text" name="dim_values" placeholder="Dimension value" value="{{ value }}">
            <button type="button" class="remove-pair" aria-label="Remove dimension">Remove</button>
          </div>
        {% endfor %}
      </div>
      <div class="section-actions">
        <button type="button" id="add-dimension">Add dimension</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Metrics</legend>
      <p>Provide metric keys and numeric values. Keys will be appended to the prefix above.</p>
      <div id="metrics-container">
        {% if initial_metrics %}
          {% for key, value in initial_metrics %}
            <div class="pair-grid">
              <input type="text" name="metric_keys" placeholder="Metric key" value="{{ key }}">
              <input type="text" name="metric_values" placeholder="Metric value" value="{{ value }}">
              <button type="button" class="remove-pair" aria-label="Remove metric">Remove</button>
            </div>
          {% endfor %}
        {% else %}
          <div class="pair-grid">
            <input type="text" name="metric_keys" placeholder="Metric key">
            <input type="text" name="metric_values" placeholder="Metric value">
            <button type="button" class="remove-pair" aria-label="Remove metric">Remove</button>
          </div>
        {% endif %}
      </div>
      <div class="section-actions">
        <button type="button" id="add-metric">Add metric</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Timestamp</legend>
      <p>Optional override in milliseconds since epoch. Left blank, the current timestamp will be used.</p>
      <label>Timestamp override
        <input type="text" name="ts" value="{{ form_defaults.ts }}">
      </label>
    </fieldset>

    <button type="submit">Submit</button>
  </form>

  <template id="dimension-template">
    <div class="pair-grid">
      <input type="text" name="dim_keys" placeholder="Dimension key">
      <input type="text" name="dim_values" placeholder="Dimension value">
      <button type="button" class="remove-pair" aria-label="Remove dimension">Remove</button>
    </div>
  </template>

  <template id="metric-template">
    <div class="pair-grid">
      <input type="text" name="metric_keys" placeholder="Metric key">
      <input type="text" name="metric_values" placeholder="Metric value">
      <button type="button" class="remove-pair" aria-label="Remove metric">Remove</button>
    </div>
  </template>

  <script>
    (function () {
      const dimensionContainer = document.getElementById('dimensions-container');
      const metricContainer = document.getElementById('metrics-container');
      const dimensionTemplate = document.getElementById('dimension-template');
      const metricTemplate = document.getElementById('metric-template');
      const addDimensionButton = document.getElementById('add-dimension');
      const addMetricButton = document.getElementById('add-metric');

      function addPair(container, template) {
        const clone = template.content.firstElementChild.cloneNode(true);
        attachRemoveHandler(clone);
        container.appendChild(clone);
      }

      function attachRemoveHandler(element) {
        const button = element.querySelector('.remove-pair');
        if (!button) {
          return;
        }
        button.addEventListener('click', () => {
          const parent = button.parentElement;
          if (parent && parent.parentElement && parent.parentElement.children.length > 1) {
            parent.remove();
          } else if (parent) {
            const inputs = parent.querySelectorAll('input');
            inputs.forEach((input) => { input.value = ''; });
          }
        });
      }

      Array.from(document.querySelectorAll('.pair-grid')).forEach(attachRemoveHandler);

      addDimensionButton.addEventListener('click', () => {
        addPair(dimensionContainer, dimensionTemplate);
      });

      addMetricButton.addEventListener('click', () => {
        addPair(metricContainer, metricTemplate);
      });
    }());
  </script>
</body>
</html>
