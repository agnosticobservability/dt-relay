<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dynatrace Metrics Relay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 960px; }
    fieldset { margin-bottom: 1.5rem; border: 1px solid #ccc; padding: 1rem; }
    legend { font-weight: bold; }
    label { display: block; margin-bottom: 0.5rem; }
    input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 0.5rem; }
    .checkbox-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .error { color: #b30000; margin-bottom: 1rem; font-weight: bold; }
    .warning { background: #fff4cd; border: 1px solid #f0c36d; padding: 0.75rem 1rem; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
    .pair-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .pair-grid input { width: 100%; }
    .pair-actions { display: flex; gap: 0.25rem; }
    .pair-actions button { width: 2.5rem; height: 2.5rem; font-size: 1.25rem; line-height: 1; padding: 0; }
    .section-actions { margin-top: 0.75rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Dynatrace Metrics Relay</h1>
  <p>Submit custom metrics and dimensions to one or more Dynatrace tenants.</p>
  {% if not auth_configured %}
    <div class="warning">
      <strong>Configuration required:</strong>
      Set the <code>AUTH_PASSWORD</code> environment variable on the server before attempting an ingest.
    </div>
  {% endif %}
  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}
  <form method="post" action="{{ url_for('metrics.ingest') }}">
    <fieldset>
      <legend>Tenant Selection</legend>
      <div class="checkbox-group">
        {% for tenant in tenants %}
          <label>
            <input type="checkbox" name="tenant_ids" value="{{ tenant.id }}" {% if tenant.id in selected_tenants %}checked{% endif %}>
            {{ tenant.label }} ({{ tenant.id }})
          </label>
        {% endfor %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Authentication</legend>
      <label>Site password
        <input type="password" name="auth_password" required>
      </label>
      <label>Global Dynatrace ingest token
        <input type="password" name="dt_token" {% if require_global_token %}required{% endif %}>
      </label>
      <div class="tokens">
        <details>
          <summary>Optional per-tenant tokens</summary>
          {% for tenant in tenants %}
            <label>{{ tenant.label }} override
              <input type="password" name="dt_token__{{ tenant.id }}">
            </label>
          {% endfor %}
        </details>
      </div>
    </fieldset>

    <fieldset>
      <legend>Metric Configuration</legend>
      <label>Metric prefix
        <input type="text" name="metric_prefix" value="{{ form_defaults.metric_prefix }}" required>
      </label>
    </fieldset>

    <fieldset>
      <legend>Dimensions</legend>
      <p>Add key/value pairs to send as dimensions with each metric line.</p>
      <div id="dimensions-container">
        {% if initial_dimensions %}
          {% for key, value in initial_dimensions %}
            <div class="pair-grid">
              <input type="text" name="dim_keys" placeholder="Dimension key" value="{{ key }}">
              <input type="text" name="dim_values" placeholder="Dimension value" value="{{ value }}">
              <div class="pair-actions">
                <button type="button" class="add-pair" aria-label="Add dimension">+</button>
                <button type="button" class="remove-pair" aria-label="Remove dimension">-</button>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Metrics</legend>
      <p>Provide metric keys and numeric values. Keys will be appended to the prefix above.</p>
      <div id="metrics-container">
        {% if initial_metrics %}
          {% for key, value in initial_metrics %}
            <div class="pair-grid">
              <input type="text" name="metric_keys" placeholder="Metric key" value="{{ key }}">
              <input type="text" name="metric_values" placeholder="Metric value" value="{{ value }}">
              <div class="pair-actions">
                <button type="button" class="add-pair" aria-label="Add metric">+</button>
                <button type="button" class="remove-pair" aria-label="Remove metric">-</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="pair-grid">
            <input type="text" name="metric_keys" placeholder="Metric key">
            <input type="text" name="metric_values" placeholder="Metric value">
            <div class="pair-actions">
              <button type="button" class="add-pair" aria-label="Add metric">+</button>
              <button type="button" class="remove-pair" aria-label="Remove metric">-</button>
            </div>
          </div>
        {% endif %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Timestamp</legend>
      <p>Optional override in milliseconds since epoch. Left blank, the current timestamp will be used.</p>
      <label>Timestamp override
        <input type="text" name="ts" value="{{ form_defaults.ts }}">
      </label>
    </fieldset>

    <button type="submit">Submit</button>
  </form>

  <template id="dimension-template">
    <div class="pair-grid">
      <input type="text" name="dim_keys" placeholder="Dimension key">
      <input type="text" name="dim_values" placeholder="Dimension value">
      <div class="pair-actions">
        <button type="button" class="add-pair" aria-label="Add dimension">+</button>
        <button type="button" class="remove-pair" aria-label="Remove dimension">-</button>
      </div>
    </div>
  </template>

  <template id="metric-template">
    <div class="pair-grid">
      <input type="text" name="metric_keys" placeholder="Metric key">
      <input type="text" name="metric_values" placeholder="Metric value">
      <div class="pair-actions">
        <button type="button" class="add-pair" aria-label="Add metric">+</button>
        <button type="button" class="remove-pair" aria-label="Remove metric">-</button>
      </div>
    </div>
  </template>

  <script>
    (function () {
      const dimensionContainer = document.getElementById('dimensions-container');
      const metricContainer = document.getElementById('metrics-container');
      const dimensionTemplate = document.getElementById('dimension-template');
      const metricTemplate = document.getElementById('metric-template');

      function updatePairControls(container) {
        const rows = Array.from(container.querySelectorAll('.pair-grid'));
        rows.forEach((row, index) => {
          const addButton = row.querySelector('.add-pair');
          const removeButton = row.querySelector('.remove-pair');

          if (addButton) {
            addButton.classList.toggle('hidden', index !== 0);
          }

          if (removeButton) {
            removeButton.classList.toggle('hidden', index === 0);
          }
        });
      }

      function addPair(container, template) {
        const clone = template.content.firstElementChild.cloneNode(true);
        attachHandlers(clone, container, template);
        container.appendChild(clone);
        updatePairControls(container);
      }

      function removePair(row, container) {
        if (container.children.length > 1) {
          row.remove();
        } else {
          row.querySelectorAll('input').forEach((input) => { input.value = ''; });
        }
        updatePairControls(container);
      }

      function attachHandlers(row, container, template) {
        const addButton = row.querySelector('.add-pair');
        const removeButton = row.querySelector('.remove-pair');

        if (addButton) {
          addButton.addEventListener('click', () => addPair(container, template));
        }

        if (removeButton) {
          removeButton.addEventListener('click', () => removePair(row, container));
        }
      }

      Array.from(dimensionContainer.querySelectorAll('.pair-grid')).forEach((row) => {
        attachHandlers(row, dimensionContainer, dimensionTemplate);
      });

      Array.from(metricContainer.querySelectorAll('.pair-grid')).forEach((row) => {
        attachHandlers(row, metricContainer, metricTemplate);
      });

      if (!dimensionContainer.children.length) {
        addPair(dimensionContainer, dimensionTemplate);
      } else {
        updatePairControls(dimensionContainer);
      }

      if (!metricContainer.children.length) {
        addPair(metricContainer, metricTemplate);
      } else {
        updatePairControls(metricContainer);
      }
    }());
  </script>
</body>
</html>
